# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    setup.sh                                           :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: ltouret <ltouret@student.42.fr>            +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2021/02/04 15:08:15 by ltouret           #+#    #+#              #
#    Updated: 2021/02/05 14:13:18 by ltouret          ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

set -e

if [[ "$OSTYPE" == "linux-gnu" ]]; then
	MINIKUBE_IP=$(kubectl get node -o=custom-columns='DATA:status.addresses[0].address' | sed -n 2p)
else
	MINIKUBE_IP=$(minikube ip)
fi

# Starting minikube ..."
minikube status > /dev/null \
	&& echo Reusing current instance. \
	|| minikube start --driver docker \
	|| panic

eval $(minikube docker-env)

echo "
MetalLB installation ..."

kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
envsubst < srcs/metallb/metallb.yaml | kubectl apply -f - || panic
kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"

docker build -t nginx_custom srcs/nginx/
docker build -t wordpress_custom srcs/wordpress/
docker build -t mysql_custom srcs/mysql/
docker build -t phpmyadmin_custom srcs/phpmyadmin/
docker build -t ftps_custom srcs/ftps/
docker build -t grafana_custom srcs/grafana/

kubectl apply -k ./srcs/
